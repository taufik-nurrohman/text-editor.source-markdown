/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2022 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).TE=t.TE||{},t.TE.SourceHTML={}))}(this,(function(t){"use strict";var e=function(t,e){return-1!==e.indexOf(t)},r=function(t){return Array.isArray(t)},n=function(t){return"function"==typeof t},o=function(t,e){return t&&s(e)&&t instanceof e},i=function(t,e){return void 0===e&&(e=!0),"object"==typeof t&&(!e||o(t,Object))},s=function(t){return function(t){return void 0!==t}(t)&&!function(t){return null===t}(t)},c=function(t){return"string"==typeof t},u=function(t){return t.length},a=function t(){for(var n=arguments.length,o=Array(n),c=0;c<n;c++)o[c]=arguments[c];for(var a=o.shift(),l=0,f=u(o);l<f;++l)for(var p in o[l])if(s(a[p]))if(r(a[p])&&r(o[l][p])){a[p]=[].concat(a[p]);for(var h=0,d=u(o[l][p]);h<d;++h)e(o[l][p][h],a[p])||a[p].push(o[l][p][h])}else i(a[p])&&i(o[l][p])?a[p]=t({},a[p],o[l][p]):a[p]=o[l][p];else a[p]=o[l][p];return a},l=window,f=l.location,p=function(t,e){return function(t){return o(t,RegExp)}(t)?t:(t=t.replace(/\//g,"\\/"),RegExp(t,s(e)?e:"g"))};function h(t,e){return new Promise((function(r,n){var o=l[t].apply(l,e);return o?r(o):n(o)}))}var d={source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},type:null}};["alert","confirm","prompt"].forEach((function(t){d.source[t]=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];return h(t,r)}}));var b={toggle:function(t,e,n,o){void 0===o&&(o=!1),e||""===e||(e=t);var i=this,s=i.$(),a=s.after,l=s.before,f=s.value,p=u(e),h=u(t);return n&&e===f.slice(-p)&&t===f.slice(0,h)||e===a.slice(0,p)&&t===l.slice(-h)?i.peel(t,e,n):(!1!==o&&(c(o)?o=[o,o]:r(o)||(o=["",""]),isSet(o[1])||(o[1]=o[0]),i.trim(o[0],o[1])),i.wrap(t,e,n))}};const m=f.protocol,{toggle:w}=b;let g="[\\w:.-]+",k=t=>"<("+t+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>",v=t=>"</("+t+")>";function y(t){return!1!==t&&(c(t)?t=[t,t]:r(t)||(t=["",""]),s(t[1])||(t[1]=t[0])),t}const q={};q.blocks=function(){let t=this;return t.record(),function(t){let e=/<(?:h([1-6])|p)(\s[^>]*)?>$/,r=/^<\/(?:h[1-6]|p)>/;t.match([e,/.*/,r],(function(n,o,i){let s=this,c=+(n[1]||0),u=n[2]||"",a=t.state.sourceMarkdown.elements||{},l=n[0]?a[n[0].slice(1,-1).split(/\s/)[0]]:["","",{}];!u&&l[2]&&(u=toAttributes(l[2])),s.replace(e,"",-1),s.replace(/\n+/g," "),s.replace(r,"",1);let f=l[3]||a.h1[3];!1!==(f=y(f))&&s.trim(f[0],f[1]),c?(++c,c>6?(s.wrap("<"+a.p[0]+(u||toAttributes(a.p[2]))+">","</"+a.p[0]+">"),o[0]&&o[0]!==a.h6[1]||s.insert(a.p[1])):(s.wrap("<"+a["h"+c][0]+(u||toAttributes(a["h"+c][2]))+">","</"+a["h"+c][0]+">"),o[0]&&o[0]!==a.p[1]||s.insert(a["h"+c][1]))):(s.wrap("<"+a.h1[0]+(u||toAttributes(a.h1[2]))+">","</"+a.h1[0]+">"),o[0]&&o[0]!==a.p[1]||s.insert(a.h1[1]))}))}(t),t.record(),!1},q.bold=function(){let t=this,e=t.state.sourceMarkdown.b||"**";return t.record(),w.apply(t,e),!1},q.code=function(){return this.record(),w.apply(this,"`"),!1},q.image=function(t="URL:",e){let r=this,{after:o,before:i,value:s}=r.$(),c=r.state,u=c.sourceMarkdown.elements||{},a=c.sourceMarkdown.tab||c.source.tab||c.tab||"\t",l=i.split("\n").pop().match(/^(\s+)/),f=l&&l[1]||"",p=c.source.prompt;return n(p)&&p(t,s&&/^https?:\/\/\S+$/.test(s)?s:e||m+"//").then((t=>{if(!t)return void r.focus();let e=u.img;s&&(e[2].alt=s,r.record());let n=e[3]||!1;!1!==(n=y(n))&&r.trim(n[0],""),e[2].src=t,o&&"\n"!==o[0]||i&&"\n"!==i.slice(-1)?r.insert("<"+e[0]+toAttributes(e[2])+">"+(!1!==n?n[1]:""),-1,!0):(n=u.figure[3]||!1,!1!==(n=y(n))&&r.trim(n[0],n[1]),r.insert(""),r.wrap(f+"<"+u.figure[0]+toAttributes(u.figure[2])+">\n"+f+a,f+"\n</"+u.figure[0]+">"),r.insert("<"+e[0]+toAttributes(e[2])+">\n"+f+a,-1),r.wrap("<"+u.figcaption[0]+toAttributes(u.figcaption[2])+">","</"+u.figcaption[0]+">").insert(u.figcaption[1]))})).catch((t=>0)),r.record(),!1},q.italic=function(){let t=this,e=t.state.sourceMarkdown.i||"_";return t.record(),w.apply(t,e),!1},q.link=function(t="URL:",e){let r=this,{value:o}=r.$(),i=r.state,s=i.sourceMarkdown.elements||{},c=i.source.prompt;return n(c)&&c(t,o&&/^https?:\/\/\S+$/.test(o)?o:e||m+"//").then((t=>{if(!t)return void r.focus();let e=s.a;o&&r.record(),e[2].href=t;let n={};/[.\/?&#]/.test(t[0])||/^(data|javascript|mailto):/.test(t)||-1===t.indexOf("://")||(n.rel="nofollow",n.target="_blank");let i=y(e[3]||!1);!1!==i||o||(i=[" "," "]),w.call(r,e[0],e[1],a(n,e[2]),i)})).catch((t=>0)),r.record(),!1},q.quote=function(){let t=this;return t.record(),function(t){let e=/<(blockquote|q)(?:\s[^>]*)?>\s*$/,r=/^\s*<\/(blockquote|q)>/;t.match([e,/.*/,r],(function(n,o,i){let s,c=this,u=t.state,a=u.sourceMarkdown.tab||u.source.tab||u.tab||"\t",l=t.state.sourceMarkdown.elements||{};c.replace(e,"",-1),c.replace(r,"",1),i[0]?l.blockquote[0]===i[1]?!1!==(s=y(l[""][3]))&&c.trim(s[0],s[1]):l.q[0]===i[1]&&(!1!==(s=y(l.blockquote[3]))&&c.trim(s[0],s[1]),c.wrap("<"+l.blockquote[0]+toAttributes(l.blockquote[2])+">\n","\n</"+l.blockquote[0]+">").insert(o[0]||l.blockquote[1]),c.replace(p("(^|\\n)"),"$1"+a)):(!1!==(s=y(l.q[3]))&&c.trim(s[0],s[1]),c.wrap("<"+l.q[0]+toAttributes(l.q[2])+">","</"+l.q[0]+">").insert(o[0]||l.q[1]),c.replace(p("(^|\\n)"+a),"$1"))}))}(t),t.record(),!1};const A={source:{type:"Markdown"},sourceMarkdown:{b:"**",h1:"===",h2:"---",i:"_",pre:"~~~"}};t.canKeyDown=function(t,e){let r=e.state,n=r.sourceMarkdown.tab||r.source.tab||r.tab||"\t",o=r.sourceMarkdown.elements||{},{key:i,queue:s}=t;if(s.Control){let{after:t,before:r,end:n,start:c,value:a}=e.$(),l=t.split("\n").shift(),f=r.split("\n").pop(),h=f.match(/^(\s+)/),d=h&&h[1]||"";if("Enter"===i){let t=l.match(p(v(g)+"\\s*$","")),r=o[t&&t[1]||"p"]||o.p;return r[3]=["\n"+d,"\n"+d],e.select(s.Shift?c-u(f):n+u(l)),w.apply(e,r),e.record(),!1}}if(s.Alt||s.Control)return!0;if(">"===i){let t,{after:r,before:n,end:i}=e.$(),s=(n.split("\n").pop()+">").match(p(k(g)+"$","")),c=o[t=s&&s[1]||""];return!t||(c?!1!==c[1]?(">"===r[0]?e.select(i+1):e.insert(">",-1),e.insert("</"+t+">",1).insert(c[1])):">"===r[0]?e.insert(" /",-1).select(i+3):e.insert(" />",-1):(">"===r[0]?e.select(i+1):e.insert(">",-1),e.insert("</"+t+">",1)),e.record(),!1)}if("Enter"===i){let t,r,{after:i,before:c,value:a}=e.$(),l=i.split("\n").shift(),f=c.split("\n").pop(),h=f.match(/^(\s+)/),d=h&&h[1]||"",b=["li","option","p","td","th"],m=["script","style"];if(t=f.match(p(k(g)+"$",""))){let r=o[t[1]];if(r&&!1===r[1])return e.insert("\n"+d,-1).record(),!1}if(s.Shift){let{br:t}=o;return e.insert("<"+t[0]+toAttributes(t[2])+">"+(!1===t[1]?"":t[1]+"</"+t[0]+">")+"\n",-1).record(),!1}if(i&&c){for(let i=0,s=u(b);i<s;++i)if(r=b[i],p("^"+v(r),"").test(l)&&(t=f.match(p("^\\s*"+k(r),""))))return t[0]===f?(o[r]&&a&&o[r][1]===a?e.insert("").wrap("\n"+d+n,"\n"+d):w.call(e,r),e.record(),!1):(e.insert("</"+r+">\n"+d+"<"+r+(t[2]||"")+">",-1).insert(o[r]&&o[r][1]||"").record(),!1);for(let t=0,n=u(m);t<n;++t)if(r=m[t],p("^"+v(r),"").test(l)&&p(k(r)+"$","").test(f))return e.wrap("\n"+d,"\n"+d).insert(o[r]&&o[r][1]||"").record(),!1;for(let t=1;t<7;++t)if(l.startsWith("</"+o["h"+t][0]+">")&&f.match(p("^\\s*"+k(o["h"+t][0]),"")))return o["h"+t]&&a&&o["h"+t][1]===a?e.insert("").wrap("\n"+d+n,"\n"+d):e.insert("</"+o["h"+t][0]+">\n"+d+"<"+o.p[0]+">",-1).replace(p("^"+v(o["h"+t][0])),"</"+o.p[0]+">",1).insert(o.p[1]),e.record(),!1}}return!0},t.commands=q,t.state=A}));