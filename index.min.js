/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2023 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).TE=t.TE||{},t.TE.SourceMarkdown={}))}(this,(function(t){"use strict";var e=function(t){return Array.isArray(t)},r=function(t){return"function"==typeof t},n=function(t,e){return t&&a(e)&&t instanceof e},i=function(t,e){return void 0===e&&(e=!0),"object"==typeof t&&(!e||n(t,Object))},a=function(t){return function(t){return void 0!==t}(t)&&!function(t){return null===t}(t)},o=function(t){return t.length},s=function t(){for(var r=arguments.length,n=Array(r),s=0;s<r;s++)n[s]=arguments[s];for(var c,u=n.shift(),f=0,l=o(n);f<l;++f)for(var p in n[f])if(a(u[p]))if(e(u[p])&&e(n[f][p])){u[p]=[].concat(u[p]);for(var d=0,h=o(n[f][p]);d<h;++d)c=n[f][p][d],-1===u[p].indexOf(c)&&u[p].push(n[f][p][d])}else i(u[p])&&i(n[f][p])?u[p]=t({},u[p],n[f][p]):u[p]=n[f][p];else u[p]=n[f][p];return u},c=window.location,u=function(t,e){return function(t){return n(t,RegExp)}(t)?t:(t=t.replace(/\//g,"\\/"),RegExp(t,a(e)?e:"g"))},f={toggle:function(t,r,n,i){void 0===i&&(i=!1),r||""===r||(r=t);var s=this,c=s.$(),u=c.after,f=c.before,l=c.value,p=o(r),d=o(t);return n&&r===l.slice(-p)&&t===l.slice(0,d)||r===u.slice(0,p)&&t===f.slice(-d)?s.peel(t,r,n):(!1!==i&&("string"==typeof i?i=[i,i]:e(i)||(i=["",""]),a(i[1])||(i[1]=i[0]),s.trim(i[0],i[1])),s.wrap(t,r,n))}},l=c.protocol,p=f.toggle,d="[\\w:.-]+",h=function(t){return"<("+t+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},v=function(t){return"</("+t+")>"};var b={};b.blocks=function(){var t=this;return t.record(),function(t){var e,r,n,i,a=t.$(),s=a.after,c=a.end,f=a.before,l=a.start,p=a.value,d=0,h=(t.state||{}).defaults||{};if(!p){var v=s.split("\n").shift(),b=f.split("\n").pop();t.select(l-o(b),c+o(v)).trim("\n\n","\n\n"),p=t.$().value}(i=(r=u("(^|\\n)([#]{1,6})[ ]+$")).exec(f))&&(d=o(i[2]),t.replace(r,"$1",-1),p=t.$().value||h["h"+d][1]),(i=(n=u("^([#]{1,6})[ ]+")).exec(p))&&(d=o(i[1]),t.replace(n,""),p=t.$().value||h["h"+d][1]),(i=(e=u("\\n([-]+|[=]+)(\\n|$)")).exec(s))&&(d="="===i[1][0]?1:2,t.replace(e,"$2",1),p=t.$().value||h["h"+d][1]),(i=(n=u("^([^\\n]+)\\n([-]+|[=]+)$")).exec(p))&&(d="="===i[2][0]?1:2,t.replace(n,"$1"),p=t.$().value||h["h"+d][1]),d?(p&&p!==h.h1[1]&&p!==h.h2[1]&&p!==h.h3[1]&&p!==h.h4[1]&&p!==h.h5[1]&&p!==h.h6[1]&&p!==h.p[1]||t.insert(p=h[d>5?"p":"h"+(d+1)][1]),1===d?(t.wrap("","\n"+"-".repeat(o(p))),++d):d<6?(t.wrap("#".repeat(d+1)+" ",""),++d):d=0):(p&&p!==h.h1[1]&&p!==h.h2[1]&&p!==h.h3[1]&&p!==h.h4[1]&&p!==h.h5[1]&&p!==h.h6[1]&&p!==h.p[1]||t.insert(p=h.h1[1]),t.trim("\n\n","\n\n").wrap("","\n"+"=".repeat(o(p))),++d)}(t),t.record(),!1},b.bold=function(){var t=this,e=t.$().value,r=t.state;r.defaults;var n=r.markdown||{},i=n.b||"**";return e||t.insert(n.defaults.b[1]),t.record(),p.call(t,i,i,!1,n.defaults.b[3]),!1},b.code=function(){var t=this,e=t.$(),r=e.after,n=e.before,i=e.value,a=t.state,o=a.defaults||{},s=(a.markdown||{}).code||"`";return i||t.insert(o.code[1]),s===r[0]&&s===n.slice(-1)?t.replace(/``/g,"`"):t.replace(/`/g,"``"),t.record(),p.call(t,s,s,!1,o.code[3]),!1},b.image=function(t,e){void 0===t&&(t="URL:");var n=this,i=n.$(),a=i.after,o=i.before,s=i.value,c=n.state,u=c.source.tab||c.tab||"\t",f=c.defaults||{},p=o.split("\n").pop().match(/^(\s+)/),d=p&&p[1]||"",h=c.source.prompt;return r(h)&&h(t,s&&/^https?:\/\/\S+$/.test(s)?s:e||l+"//").then((function(t){if(t){var e=f.img;s&&(e[2].alt=s,n.record());var r=e[3]||!1;!1!==(r=toTidy(r))&&n.trim(r[0],""),e[2].src=t,a&&"\n"!==a[0]||o&&"\n"!==o.slice(-1)?n.insert("<"+e[0]+toAttributes(e[2])+">"+(!1!==r?r[1]:""),-1,!0):(r=f.figure[3]||!1,!1!==(r=toTidy(r))&&n.trim(r[0],r[1]),n.insert(""),n.wrap(d+"<"+f.figure[0]+toAttributes(f.figure[2])+">\n"+d+u,d+"\n</"+f.figure[0]+">"),n.insert("<"+e[0]+toAttributes(e[2])+">\n"+d+u,-1),n.wrap("<"+f.figcaption[0]+toAttributes(f.figcaption[2])+">","</"+f.figcaption[0]+">").insert(f.figcaption[1]))}else n.focus()})).catch((function(t){return 0})),n.record(),!1},b.italic=function(){var t=this,e=t.$().value,r=t.state,n=r.defaults||{},i=r.markdown||{},a=i.i||"_";return e||t.insert(i.defaults.i[1]),t.record(),p.call(t,a,a,!1,n.i[3]),!1},b.link=function(t,e){void 0===t&&(t="URL:");var n=this,i=n.$().value,a=n.state,o=a.defaults||{},c=a.source.prompt;return r(c)&&c(t,i&&/^https?:\/\/\S+$/.test(i)?i:e||l+"//").then((function(t){if(t){var e=o.a;i&&n.record(),e[2].href=t;var r={};/[.\/?&#]/.test(t[0])||/^(data|javascript|mailto):/.test(t)||-1===t.indexOf("://")||(r.rel="nofollow",r.target="_blank");var a=toTidy(e[3]||!1);!1!==a||i||(a=[" "," "]),p.call(n,e[0],e[1],s(r,e[2]),a)}else n.focus()})).catch((function(t){return 0})),n.record(),!1},b.quote=function(){return this.record(),this.record(),!1};var $={markdown:{b:"**",h1:"=",h2:"-",h3:"### ",h4:"#### ",h5:"##### ",h6:"###### ",i:"_",pre:"~~~"},source:{type:"Markdown"}};t.canKeyDown=function(t,e){var r=e.state,n=r.source.tab||r.tab||"\t",i=r.defaults||{},a=t.key,s=t.queue;if(s.Control){var c=e.$(),f=c.after,l=c.before,b=c.end,$=c.start;c.value;var g=f.split("\n").shift(),m=l.split("\n").pop(),w=m.match(/^(\s+)/),y=w&&w[1]||"";if("Enter"===a){var x=g.match(u(v(d)+"\\s*$","")),k=i[x&&x[1]||"p"]||i.p;return k[3]=["\n"+y,"\n"+y],e.select(s.Shift?$-o(m):b+o(g)),p.apply(e,k),e.record(),!1}}if(s.Alt||s.Control)return!0;if(">"===a){var A,T=e.$(),E=T.after,j=T.before,S=T.end,_=(j.split("\n").pop()+">").match(u(h(d)+"$","")),O=i[A=_&&_[1]||""];return!A||(O?!1!==O[1]?(">"===E[0]?e.select(S+1):e.insert(">",-1),e.insert("</"+A+">",1).insert(O[1])):">"===E[0]?e.insert(" /",-1).select(S+3):e.insert(" />",-1):(">"===E[0]?e.select(S+1):e.insert(">",-1),e.insert("</"+A+">",1)),e.record(),!1)}if("Enter"===a){var R,M,q=e.$(),C=q.after,L=q.before,U=q.value,D=C.split("\n").shift(),K=L.split("\n").pop(),P=K.match(/^(\s+)/),W=P&&P[1]||"",z=["li","option","p","td","th"],B=["script","style"];if(R=K.match(u(h(d)+"$",""))){var F=i[R[1]];if(F&&!1===F[1])return e.insert("\n"+W,-1).record(),!1}if(s.Shift){var G=i.br;return e.insert("<"+G[0]+toAttributes(G[2])+">"+(!1===G[1]?"":G[1]+"</"+G[0]+">")+"\n",-1).record(),!1}if(C&&L){for(var H=0,I=o(z);H<I;++H)if(u("^"+v(M=z[H]),"").test(D)&&(R=K.match(u("^\\s*"+h(M),""))))return R[0]===K?(i[M]&&U&&i[M][1]===U?e.insert("").wrap("\n"+W+n,"\n"+W):p.call(e,M),e.record(),!1):(e.insert("</"+M+">\n"+W+"<"+M+(R[2]||"")+">",-1).insert(i[M]&&i[M][1]||"").record(),!1);for(var J=0,N=o(B);J<N;++J)if(u("^"+v(M=B[J]),"").test(D)&&u(h(M)+"$","").test(K))return e.wrap("\n"+W,"\n"+W).insert(i[M]&&i[M][1]||"").record(),!1;for(var Q=1;Q<7;++Q)if(D.startsWith("</"+i["h"+Q][0]+">")&&K.match(u("^\\s*"+h(i["h"+Q][0]),"")))return i["h"+Q]&&U&&i["h"+Q][1]===U?e.insert("").wrap("\n"+W+n,"\n"+W):e.insert("</"+i["h"+Q][0]+">\n"+W+"<"+i.p[0]+">",-1).replace(u("^"+v(i["h"+Q][0])),"</"+i.p[0]+">",1).insert(i.p[1]),e.record(),!1}}return!0},t.commands=b,t.state=$,Object.defineProperty(t,"__esModule",{value:!0})}));