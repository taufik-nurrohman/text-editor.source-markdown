/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2023 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).TE=t.TE||{},t.TE.SourceMarkdown={}))}(this,(function(t){"use strict";var e=function(t,e){return-1!==e.indexOf(t)},r=function(t){return Array.isArray(t)},n=function(t){return"function"==typeof t},o=function(t,e){return t&&s(e)&&t instanceof e},i=function(t,e){return void 0===e&&(e=!0),"object"==typeof t&&(!e||o(t,Object))},s=function(t){return function(t){return void 0!==t}(t)&&!function(t){return null===t}(t)},c=window,a=c.location,u=function(t,e){return function(t){return o(t,RegExp)}(t)?t:(t=t.replace(/\//g,"\\/"),RegExp(t,s(e)?e:"g"))},l=function(t){return t.length},f=function t(){for(var n=arguments.length,o=Array(n),c=0;c<n;c++)o[c]=arguments[c];for(var a=o.shift(),u=0,f=l(o);u<f;++u)for(var p in o[u])if(s(a[p]))if(r(a[p])&&r(o[u][p])){a[p]=[].concat(a[p]);for(var d=0,h=l(o[u][p]);d<h;++d)e(o[u][p][d],a[p])||a[p].push(o[u][p][d])}else i(a[p])&&i(o[u][p])?a[p]=t({},a[p],o[u][p]):a[p]=o[u][p];else a[p]=o[u][p];return a},p=function(t){return t.length};function d(t,e){return new Promise((function(r,n){var o=c[t].apply(c,e);return o?r(o):n(o)}))}var h={source:{pairs:{"`":"`","(":")","{":"}","[":"]",'"':'"',"'":"'","<":">"},type:null}};["alert","confirm","prompt"].forEach((function(t){h.source[t]=function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];return d(t,r)}}));var b={toggle:function(t,e,n,o){void 0===o&&(o=!1),e||""===e||(e=t);var i=this,s=i.$(),c=s.after,a=s.before,u=s.value,l=p(e),f=p(t);return n&&e===u.slice(-l)&&t===u.slice(0,f)||e===c.slice(0,l)&&t===a.slice(-f)?i.peel(t,e,n):(!1!==o&&("string"==typeof o?o=[o,o]:r(o)||(o=["",""]),isSet(o[1])||(o[1]=o[0]),i.trim(o[0],o[1])),i.wrap(t,e,n))}};const m=a.protocol,{toggle:v}=b;let g="[\\w:.-]+",w=t=>"<("+t+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>",y=t=>"</("+t+")>";const $={};$.blocks=function(){let t=this;return t.record(),function(t){let e,r,n,o,{after:i,end:s,before:c,start:a,value:f}=t.$(),p=0;if(t.state.sourceMarkdown,!f){let e=i.split("\n").shift(),r=c.split("\n").pop();t.select(a-l(r),s+l(e)).trim("\n\n","\n\n"),f=t.$().value}(o=(r=u("(^|\\n)([#]{1,6})[ ]+$")).exec(c))&&(p=l(o[2]),t.replace(r,"$1",-1),f=t.$().value),(o=(n=u("^([#]{1,6})[ ]+")).exec(f))&&(p=l(o[1]),t.replace(n,""),f=t.$().value),(o=(e=u("\\n([-]+|[=]+)(\\n|$)")).exec(i))&&(p="="===o[1][0]?1:2,t.replace(e,"$2",1),f=t.$().value),(o=(n=u("^([^\\n]+)\\n([-]+|[=]+)$")).exec(f))&&(p="="===o[2][0]?1:2,t.replace(n,"$1"),f=t.$().value),p?1===p?(t.wrap("","\n"+"-".repeat(l(f))),++p):p<6?(t.wrap("#".repeat(p+1)+" ",""),++p):p=0:(t.trim("\n\n","\n\n").wrap("","\n"+"=".repeat(l(f))),++p)}(t),t.record(),!1},$.bold=function(){let t=this,e=t.state.sourceMarkdown.b||"**";return t.record(),v.apply(t,e),!1},$.code=function(){return this.record(),v.apply(this,"`"),!1},$.image=function(t="URL:",e){let r=this,{after:o,before:i,value:s}=r.$(),c=r.state,a=c.sourceMarkdown.elements||{},u=c.sourceMarkdown.tab||c.source.tab||c.tab||"\t",l=i.split("\n").pop().match(/^(\s+)/),f=l&&l[1]||"",p=c.source.prompt;return n(p)&&p(t,s&&/^https?:\/\/\S+$/.test(s)?s:e||m+"//").then((t=>{if(!t)return void r.focus();let e=a.img;s&&(e[2].alt=s,r.record());let n=e[3]||!1;!1!==(n=toTidy(n))&&r.trim(n[0],""),e[2].src=t,o&&"\n"!==o[0]||i&&"\n"!==i.slice(-1)?r.insert("<"+e[0]+toAttributes(e[2])+">"+(!1!==n?n[1]:""),-1,!0):(n=a.figure[3]||!1,!1!==(n=toTidy(n))&&r.trim(n[0],n[1]),r.insert(""),r.wrap(f+"<"+a.figure[0]+toAttributes(a.figure[2])+">\n"+f+u,f+"\n</"+a.figure[0]+">"),r.insert("<"+e[0]+toAttributes(e[2])+">\n"+f+u,-1),r.wrap("<"+a.figcaption[0]+toAttributes(a.figcaption[2])+">","</"+a.figcaption[0]+">").insert(a.figcaption[1]))})).catch((t=>0)),r.record(),!1},$.italic=function(){let t=this,e=t.state.sourceMarkdown.i||"_";return t.record(),v.apply(t,e),!1},$.link=function(t="URL:",e){let r=this,{value:o}=r.$(),i=r.state,s=i.sourceMarkdown.elements||{},c=i.source.prompt;return n(c)&&c(t,o&&/^https?:\/\/\S+$/.test(o)?o:e||m+"//").then((t=>{if(!t)return void r.focus();let e=s.a;o&&r.record(),e[2].href=t;let n={};/[.\/?&#]/.test(t[0])||/^(data|javascript|mailto):/.test(t)||-1===t.indexOf("://")||(n.rel="nofollow",n.target="_blank");let i=toTidy(e[3]||!1);!1!==i||o||(i=[" "," "]),v.call(r,e[0],e[1],f(n,e[2]),i)})).catch((t=>0)),r.record(),!1},$.quote=function(){return this.record(),this.record(),!1};const k={source:{type:"Markdown"},sourceMarkdown:{b:"**",h1:"=",h2:"-",h3:"### ",h4:"#### ",h5:"##### ",h6:"###### ",i:"_",pre:"~~~"}};t.canKeyDown=function(t,e){let r=e.state,n=r.sourceMarkdown.tab||r.source.tab||r.tab||"\t",o=r.sourceMarkdown.elements||{},{key:i,queue:s}=t;if(s.Control){let{after:t,before:r,end:n,start:c,value:a}=e.$(),f=t.split("\n").shift(),p=r.split("\n").pop(),d=p.match(/^(\s+)/),h=d&&d[1]||"";if("Enter"===i){let t=f.match(u(y(g)+"\\s*$","")),r=o[t&&t[1]||"p"]||o.p;return r[3]=["\n"+h,"\n"+h],e.select(s.Shift?c-l(p):n+l(f)),v.apply(e,r),e.record(),!1}}if(s.Alt||s.Control)return!0;if(">"===i){let t,{after:r,before:n,end:i}=e.$(),s=(n.split("\n").pop()+">").match(u(w(g)+"$","")),c=o[t=s&&s[1]||""];return!t||(c?!1!==c[1]?(">"===r[0]?e.select(i+1):e.insert(">",-1),e.insert("</"+t+">",1).insert(c[1])):">"===r[0]?e.insert(" /",-1).select(i+3):e.insert(" />",-1):(">"===r[0]?e.select(i+1):e.insert(">",-1),e.insert("</"+t+">",1)),e.record(),!1)}if("Enter"===i){let t,r,{after:i,before:c,value:a}=e.$(),f=i.split("\n").shift(),p=c.split("\n").pop(),d=p.match(/^(\s+)/),h=d&&d[1]||"",b=["li","option","p","td","th"],m=["script","style"];if(t=p.match(u(w(g)+"$",""))){let r=o[t[1]];if(r&&!1===r[1])return e.insert("\n"+h,-1).record(),!1}if(s.Shift){let{br:t}=o;return e.insert("<"+t[0]+toAttributes(t[2])+">"+(!1===t[1]?"":t[1]+"</"+t[0]+">")+"\n",-1).record(),!1}if(i&&c){for(let i=0,s=l(b);i<s;++i)if(r=b[i],u("^"+y(r),"").test(f)&&(t=p.match(u("^\\s*"+w(r),""))))return t[0]===p?(o[r]&&a&&o[r][1]===a?e.insert("").wrap("\n"+h+n,"\n"+h):v.call(e,r),e.record(),!1):(e.insert("</"+r+">\n"+h+"<"+r+(t[2]||"")+">",-1).insert(o[r]&&o[r][1]||"").record(),!1);for(let t=0,n=l(m);t<n;++t)if(r=m[t],u("^"+y(r),"").test(f)&&u(w(r)+"$","").test(p))return e.wrap("\n"+h,"\n"+h).insert(o[r]&&o[r][1]||"").record(),!1;for(let t=1;t<7;++t)if(f.startsWith("</"+o["h"+t][0]+">")&&p.match(u("^\\s*"+w(o["h"+t][0]),"")))return o["h"+t]&&a&&o["h"+t][1]===a?e.insert("").wrap("\n"+h+n,"\n"+h):e.insert("</"+o["h"+t][0]+">\n"+h+"<"+o.p[0]+">",-1).replace(u("^"+y(o["h"+t][0])),"</"+o.p[0]+">",1).insert(o.p[1]),e.record(),!1}}return!0},t.commands=$,t.state=k}));