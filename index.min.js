/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2023 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).TE=e.TE||{},e.TE.SourceMarkdown={}))}(this,(function(e){"use strict";var t=function(e){return Array.isArray(e)},r=function(e){return"function"==typeof e},n=function(e,t){return e&&i(t)&&e instanceof t},o=function(e,t){return void 0===t&&(t=!0),"object"==typeof e&&(!t||n(e,Object))},i=function(e){return function(e){return void 0!==e}(e)&&!function(e){return null===e}(e)},s=function(e){return e.length},a=function e(){for(var r=arguments.length,n=Array(r),a=0;a<r;a++)n[a]=arguments[a];for(var c,u=n.shift(),l=0,f=s(n);l<f;++l)for(var h in n[l])if(i(u[h]))if(t(u[h])&&t(n[l][h])){u[h]=[].concat(u[h]);for(var p=0,d=s(n[l][h]);p<d;++p)c=n[l][h][p],-1===u[h].indexOf(c)&&u[h].push(n[l][h][p])}else o(u[h])&&o(n[l][h])?u[h]=e({},u[h],n[l][h]):u[h]=n[l][h];else u[h]=n[l][h];return u},c=window.location,u=function(e,t){return function(e){return n(e,RegExp)}(e)?e:(e=e.replace(/\//g,"\\/"),RegExp(e,i(t)?t:"g"))},l={toggle:function(e,r,n,o){void 0===o&&(o=!1),r||""===r||(r=e);var a=this,c=a.$(),u=c.after,l=c.before,f=c.value,h=s(r),p=s(e);return n&&r===f.slice(-h)&&e===f.slice(0,p)||r===u.slice(0,h)&&e===l.slice(-p)?a.peel(e,r,n):(!1!==o&&("string"==typeof o?o=[o,o]:t(o)||(o=["",""]),i(o[1])||(o[1]=o[0]),a.trim(o[0],o[1])),a.wrap(e,r,n))}},f=c.protocol,h=l.toggle,p="[\\w:.-]+",d=function(e){return"<("+e+")(\\s(?:'(?:\\\\.|[^'])*'|\"(?:\\\\.|[^\"])*\"|[^/>'\"])*)?>"},v=function(e){return"</("+e+")>"};var g={};g.blocks=function(){var e=this;return e.record(),function(e){var t,r,n,o,i=e.$(),a=i.after,c=i.end,l=i.before,f=i.start,h=i.value,p=0,d=(e.state.sourceMarkdown||{}).defaults||{};if(!h){var v=a.split("\n").shift(),g=l.split("\n").pop();e.select(f-s(g),c+s(v)).trim("\n\n","\n\n"),h=e.$().value}(o=(r=u("(^|\\n)([#]{1,6})[ ]+$")).exec(l))&&(p=s(o[2]),e.replace(r,"$1",-1),h=e.$().value||d["h"+p][0]),(o=(n=u("^([#]{1,6})[ ]+")).exec(h))&&(p=s(o[1]),e.replace(n,""),h=e.$().value||d["h"+p][0]),(o=(t=u("\\n([-]+|[=]+)(\\n|$)")).exec(a))&&(p="="===o[1][0]?1:2,e.replace(t,"$2",1),h=e.$().value||d["h"+p][0]),(o=(n=u("^([^\\n]+)\\n([-]+|[=]+)$")).exec(h))&&(p="="===o[2][0]?1:2,e.replace(n,"$1"),h=e.$().value||d["h"+p][0]),p?(h&&h!==d.h1[0]&&h!==d.h2[0]&&h!==d.h3[0]&&h!==d.h4[0]&&h!==d.h5[0]&&h!==d.h6[0]&&h!==d.p[0]||e.insert(h=d[p>5?"p":"h"+(p+1)][0]),1===p?(e.wrap("","\n"+"-".repeat(s(h))),++p):p<6?(e.wrap("#".repeat(p+1)+" ",""),++p):p=0):(h&&h!==d.h2[0]&&h!==d.h3[0]&&h!==d.h4[0]&&h!==d.h5[0]&&h!==d.h6[0]&&h!==d.p[0]||e.insert(h=d.h1[0]),e.trim("\n\n","\n\n").wrap("","\n"+"=".repeat(s(h))),++p)}(e),e.record(),!1},g.bold=function(){var e=this,t=e.$().value,r=e.state.sourceMarkdown||{},n=r.e||"**";return t||e.insert(r.defaults.b[0]),e.record(),h.call(e,n,n,!1,r.defaults.b[2]),!1},g.code=function(){var e=this,t=e.$(),r=t.after,n=t.before,o=t.value,i=e.state.sourceMarkdown||{},s=i.code||"`";return o||e.insert(i.defaults.code[0]),s===r[0]&&s===n.slice(-1)?e.replace(/`(?=`)/g,""):e.replace(/`(?!=`)/g,"``"),e.record(),h.call(e,s,s,!1,i.defaults.code[2]),!1},g.image=function(e,t){void 0===e&&(e="URL:");var n=this,o=n.$(),i=o.after,s=o.before,a=o.value,c=n.state,u=c.sourceMarkdown.elements||{},l=c.sourceMarkdown.tab||c.source.tab||c.tab||"\t",h=s.split("\n").pop().match(/^(\s+)/),p=h&&h[1]||"",d=c.source.prompt;return r(d)&&d(e,a&&/^https?:\/\/\S+$/.test(a)?a:t||f+"//").then((function(e){if(e){var t=u.img;a&&(t[2].alt=a,n.record());var r=t[3]||!1;!1!==(r=toTidy(r))&&n.trim(r[0],""),t[2].src=e,i&&"\n"!==i[0]||s&&"\n"!==s.slice(-1)?n.insert("<"+t[0]+toAttributes(t[2])+">"+(!1!==r?r[1]:""),-1,!0):(r=u.figure[3]||!1,!1!==(r=toTidy(r))&&n.trim(r[0],r[1]),n.insert(""),n.wrap(p+"<"+u.figure[0]+toAttributes(u.figure[2])+">\n"+p+l,p+"\n</"+u.figure[0]+">"),n.insert("<"+t[0]+toAttributes(t[2])+">\n"+p+l,-1),n.wrap("<"+u.figcaption[0]+toAttributes(u.figcaption[2])+">","</"+u.figcaption[0]+">").insert(u.figcaption[1]))}else n.focus()})).catch((function(e){return 0})),n.record(),!1},g.italic=function(){var e=this,t=e.$().value,r=e.state.sourceMarkdown||{},n=r.i||"_";return t||e.insert(r.defaults.i[0]),e.record(),h.call(e,n,n,!1,r.defaults.i[2]),!1},g.link=function(e,t){void 0===e&&(e="URL:");var n=this,o=n.$().value,i=n.state,s=i.sourceMarkdown.elements||{},c=i.source.prompt;return r(c)&&c(e,o&&/^https?:\/\/\S+$/.test(o)?o:t||f+"//").then((function(e){if(e){var t=s.a;o&&n.record(),t[2].href=e;var r={};/[.\/?&#]/.test(e[0])||/^(data|javascript|mailto):/.test(e)||-1===e.indexOf("://")||(r.rel="nofollow",r.target="_blank");var i=toTidy(t[3]||!1);!1!==i||o||(i=[" "," "]),h.call(n,t[0],t[1],a(r,t[2]),i)}else n.focus()})).catch((function(e){return 0})),n.record(),!1},g.quote=function(){return this.record(),this.record(),!1};var b={source:{type:"Markdown"},sourceMarkdown:{defaults:{"":["text goes here…",{},""],a:["link text goes here…",{}],b:["text goes here…",{}],blockquote:["quote goes here…",{},"\n"],code:["code goes here…",{}],h1:["title level 1 goes here…",{},"\n"],h2:["title level 2 goes here…",{},"\n"],h3:["title level 3 goes here…",{},"\n"],h4:["title level 4 goes here…",{},"\n"],h5:["title level 5 goes here…",{},"\n"],h6:["title level 6 goes here…",{},"\n"],i:["text goes here…",{}],img:[!1,{alt:"image text goes here…",src:""}," "],li:["list item goes here…",{},"\n"],p:["paragraph goes here…",{},"\n"],pre:["code goes here…",{},"\n"],td:["data goes here…",{},"\n"],th:["title goes here…",{},"\n"]},b:"**",h1:"=",h2:"-",h3:"### ",h4:"#### ",h5:"##### ",h6:"###### ",i:"_",pre:"~~~"}};e.canKeyDown=function(e,t){var r=t.state,n=r.sourceMarkdown.tab||r.source.tab||r.tab||"\t",o=r.sourceMarkdown.elements||{},i=e.key,a=e.queue;if(a.Control){var c=t.$(),l=c.after,f=c.before,g=c.end,b=c.start;c.value;var m=l.split("\n").shift(),$=f.split("\n").pop(),w=$.match(/^(\s+)/),y=w&&w[1]||"";if("Enter"===i){var k=m.match(u(v(p)+"\\s*$","")),x=o[k&&k[1]||"p"]||o.p;return x[3]=["\n"+y,"\n"+y],t.select(a.Shift?b-s($):g+s(m)),h.apply(t,x),t.record(),!1}}if(a.Alt||a.Control)return!0;if(">"===i){var M,A=t.$(),T=A.after,E=A.before,j=A.end,S=(E.split("\n").pop()+">").match(u(d(p)+"$","")),_=o[M=S&&S[1]||""];return!M||(_?!1!==_[1]?(">"===T[0]?t.select(j+1):t.insert(">",-1),t.insert("</"+M+">",1).insert(_[1])):">"===T[0]?t.insert(" /",-1).select(j+3):t.insert(" />",-1):(">"===T[0]?t.select(j+1):t.insert(">",-1),t.insert("</"+M+">",1)),t.record(),!1)}if("Enter"===i){var q,O,R=t.$(),C=R.after,L=R.before,U=R.value,D=C.split("\n").shift(),K=L.split("\n").pop(),P=K.match(/^(\s+)/),W=P&&P[1]||"",z=["li","option","p","td","th"],B=["script","style"];if(q=K.match(u(d(p)+"$",""))){var F=o[q[1]];if(F&&!1===F[1])return t.insert("\n"+W,-1).record(),!1}if(a.Shift){var G=o.br;return t.insert("<"+G[0]+toAttributes(G[2])+">"+(!1===G[1]?"":G[1]+"</"+G[0]+">")+"\n",-1).record(),!1}if(C&&L){for(var H=0,I=s(z);H<I;++H)if(u("^"+v(O=z[H]),"").test(D)&&(q=K.match(u("^\\s*"+d(O),""))))return q[0]===K?(o[O]&&U&&o[O][1]===U?t.insert("").wrap("\n"+W+n,"\n"+W):h.call(t,O),t.record(),!1):(t.insert("</"+O+">\n"+W+"<"+O+(q[2]||"")+">",-1).insert(o[O]&&o[O][1]||"").record(),!1);for(var J=0,N=s(B);J<N;++J)if(u("^"+v(O=B[J]),"").test(D)&&u(d(O)+"$","").test(K))return t.wrap("\n"+W,"\n"+W).insert(o[O]&&o[O][1]||"").record(),!1;for(var Q=1;Q<7;++Q)if(D.startsWith("</"+o["h"+Q][0]+">")&&K.match(u("^\\s*"+d(o["h"+Q][0]),"")))return o["h"+Q]&&U&&o["h"+Q][1]===U?t.insert("").wrap("\n"+W+n,"\n"+W):t.insert("</"+o["h"+Q][0]+">\n"+W+"<"+o.p[0]+">",-1).replace(u("^"+v(o["h"+Q][0])),"</"+o.p[0]+">",1).insert(o.p[1]),t.record(),!1}}return!0},e.commands=g,e.state=b,Object.defineProperty(e,"__esModule",{value:!0})}));